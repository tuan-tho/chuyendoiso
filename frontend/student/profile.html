<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Hồ sơ cá nhân | Cổng sinh viên KTX</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600" rel="stylesheet"/>
  <link rel="stylesheet" href="./student.css"/>

  <style>
    /* ================= Modal cập nhật (nền trắng) ================= */
    .modal-backdrop {
      position: fixed; inset: 0;
      background: rgba(0,0,0,.5);
      display: none; align-items: center; justify-content: center;
      z-index: 1000;
    }
    .modal {
      background: #fff; color: #111827;
      width: min(560px, 95vw);
      border-radius: 12px; border: 1px solid #e5e7eb;
      box-shadow: 0 15px 40px rgba(0,0,0,.25);
      overflow: hidden;
    }
    .modal header, .modal footer {
      padding: 14px 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex; justify-content: space-between; align-items: center;
    }
    .modal footer {
      border-top: 1px solid #e5e7eb; border-bottom: none; justify-content: flex-end;
      background: #f9fafb;
    }
    .modal .body { padding: 18px 20px; max-height: 70vh; overflow-y: auto; }
    .form-row { margin-bottom: 14px; }
    label { font-size: 14px; color: #374151; display: block; margin-bottom: 6px; font-weight: 500; }
    input {
      width: 100%; padding: 10px 12px; border-radius: 8px;
      border: 1px solid #d1d5db; background: #fff; color: #111827;
      transition: border-color .2s;
    }
    input:focus {
      outline: none; border-color: #2563eb; box-shadow: 0 0 0 2px rgba(37,99,235,0.1);
    }
    .btn {
      padding: 8px 14px; border-radius: 8px; border: 1px solid #d1d5db;
      background: #f3f4f6; color: #111827; cursor: pointer;
      transition: all .2s;
    }
    .btn.primary { background: #2563eb; border-color: #1d4ed8; color: #fff; }
    .btn:hover { background: #e5e7eb; }
    .btn.primary:hover { background: #1e40af; }
    .btn[disabled] { opacity: .6; cursor: not-allowed; }

    /* === Header profile chỉnh lại === */
    .profile-header {
      position: relative;
      display: flex;
      align-items: center;
      gap: 16px;
      padding-right: 80px;
    }
    .ph-main h2 { margin: 0; font-size: 20px; font-weight: 700; color: #111827; }
    .ph-meta { color: #4b5563; font-size: 14px; display: flex; gap: 12px; flex-wrap: wrap; }
    .ph-actions { position: absolute; top: 16px; right: 20px; }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <span class="material-symbols-outlined">apartment</span>
        <span>Cổng Sinh viên KTX</span>
      </div>
      <nav class="menu">
        <a class="menu-item" href="./student.html"><span class="material-symbols-outlined">home</span>Trang chủ</a>
        <a class="menu-item active" href="./profile.html"><span class="material-symbols-outlined">badge</span>Hồ sơ cá nhân</a>
        <a class="menu-item" href="./checkin.html"><span class="material-symbols-outlined">how_to_reg</span>Check-in/Check-out</a>
        <a class="menu-item" href="./report.html"><span class="material-symbols-outlined">report</span>Báo cáo sự cố</a>
        <a class="menu-item" href="../common/login.html" onclick="ktxAuth.logoutCurrent(); return false;">
          <span class="material-symbols-outlined">logout</span>Đăng xuất
        </a>
      </nav>
    </aside>

    <main class="main">
      <header class="topbar">
        <h2>Hồ sơ cá nhân</h2>
        <p class="muted">Tài khoản: <b data-current-username></b></p>
      </header>

      <section class="content">
        <!-- Header -->
        <section class="card profile-header">
          <img class="avatar" src="https://i.pravatar.cc/120?img=14" alt="avatar">
          <div class="ph-main">
            <h2 id="pf_full_name">Tên sinh viên</h2>
            <div class="ph-meta">
              <span><b>MSSV:</b> <span id="pf_student_code">—</span></span>
              <span><b>Khoa:</b> <span id="pf_faculty">—</span></span>
              <span><b>Phòng:</b> <span id="pf_room">—</span></span>
            </div>
          </div>
          <div class="ph-actions">
            <button class="btn primary" id="btnEdit">Cập nhật</button>
          </div>
        </section>

        <!-- Info -->
        <section class="card info-card">
          <h3>Thông tin cá nhân</h3>
          <div class="kv">
            <div><span>Ngày sinh</span><b id="pf_dob">—</b></div>
            <div><span>Giới tính</span><b id="pf_gender">—</b></div>
            <div><span>SĐT</span><b id="pf_phone">—</b></div>
            <div><span>Email</span><b id="pf_email">—</b></div>
            <div><span>Khoa</span><b id="pf_faculty_2">—</b></div>
            <div><span>Địa chỉ</span><b id="pf_address">—</b></div>
          </div>
        </section>

        <section class="card info-card">
          <h3>Cư trú</h3>
          <div class="kv">
            <div><span>Tòa</span><b id="pf_building">KSSV</b></div>
            <div><span>Phòng</span><b id="pf_room_2">—</b></div>
            <div><span>Giường</span><b id="pf_bed">—</b></div>
          </div>
        </section>

        <p id="pf-msg" class="muted"></p>
      </section>
    </main>
  </div>

  <!-- Modal cập nhật -->
  <div class="modal-backdrop" id="mdEdit">
    <div class="modal">
      <header>
        <h3>Cập nhật hồ sơ</h3>
        <button class="btn" id="btnClose">✕</button>
      </header>
      <div class="body">
        <form id="formProfile">
          <div class="form-row"><label>Họ và tên</label><input id="full_name" type="text"></div>
          <div class="form-row"><label>Email</label><input id="email" type="email"></div>
          <div class="form-row"><label>Điện thoại</label><input id="phone" type="text"></div>
          <div class="form-row"><label>Địa chỉ</label><input id="address" type="text"></div>
        </form>
      </div>
      <footer>
        <button class="btn" id="btnCancel">Hủy</button>
        <button class="btn primary" id="btnSave" type="button">Lưu</button>
      </footer>
    </div>
  </div>

  <script src="../common/script.js"></script>
  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      ktxAuth.requireAuth(["student"]);

      const md = document.getElementById("mdEdit");
      const btnEdit = document.getElementById("btnEdit");
      const btnClose = document.getElementById("btnClose");
      const btnCancel = document.getElementById("btnCancel");
      const btnSave = document.getElementById("btnSave");

      const showModal = () => md.style.display="flex";
      const hideModal = () => md.style.display="none";
      btnEdit.onclick = showModal; btnClose.onclick = hideModal; btnCancel.onclick = hideModal;
      md.onclick = e=>{if(e.target===md)hideModal()};

      const setText = (id,v)=>{const el=document.getElementById(id); if(el) el.textContent = (v ?? "—");};
      const fmtDate=v=>v?new Date(v).toLocaleDateString("vi-VN"):"—";

      async function loadProfile(){
        const [resP, resU] = await Promise.all([
          ktxAuth.apiFetch("/profile/me"),
          ktxAuth.apiFetch("/users/me")
        ]);

        if(!resP.ok || !resU.ok){
          document.querySelector('[data-current-username]').textContent = "-";
          document.getElementById("pf-msg").textContent = "Không tải được hồ sơ";
          return;
        }

        const [p, u] = [await resP.json(), await resU.json()];

        document.querySelector('[data-current-username]').textContent = u.username || "-";
        setText("pf_full_name", u.full_name);
        setText("pf_student_code", u.username);
        setText("pf_faculty", u.faculty);
        setText("pf_room", u.room);
        setText("pf_phone", u.phone);
        setText("pf_email", u.email);
        setText("pf_faculty_2", u.faculty);
        setText("pf_address", p.address);
        setText("pf_gender", p.gender);
        document.getElementById("pf_dob").textContent = fmtDate(p.dob);

        // Nếu tòa trống thì mặc định là KSSV
        const building = p.building || "KSSV";
        document.getElementById("pf_building").textContent = building;
        setText("pf_room_2", u.room);
        setText("pf_bed", p.bed);

        document.getElementById("full_name").value = u.full_name || "";
        document.getElementById("email").value     = u.email || "";
        document.getElementById("phone").value     = u.phone || "";
        document.getElementById("address").value   = p.address || "";
      }

      async function saveProfile(){
        const payload = {
          full_name: document.getElementById("full_name").value.trim() || null,
          email:     document.getElementById("email").value.trim() || null,
          phone:     document.getElementById("phone").value.trim() || null,
          address:   document.getElementById("address").value.trim() || null,
        };

        btnSave.disabled = true; btnSave.textContent = "Đang lưu...";
        const res = await ktxAuth.apiFetch("/profile/me", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        btnSave.disabled = false; btnSave.textContent = "Lưu";

        if (!res.ok) {
          let msg = "";
          try {
            const raw = await res.text();
            try {
              const j = JSON.parse(raw);
              msg = j.detail || (Array.isArray(j) ? j.map(e => e.msg).join("; ") : JSON.stringify(j));
            } catch { msg = raw; }
          } catch { msg = res.statusText || "Unknown error"; }
          alert("Lỗi lưu hồ sơ: " + msg);
          return;
        }

        hideModal();
        await loadProfile();
      }

      btnSave.onclick = saveProfile;
      await loadProfile();
    });
  </script>
</body>
</html>
