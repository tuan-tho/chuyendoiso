<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Báo cáo sự cố – Sinh viên | KTX-DNU</title>

  <!-- Font & Icon -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600" rel="stylesheet" />

  <link rel="stylesheet" href="./student.css" />

  <style>
    :root{
      --card-bg:#fff; --muted:#6b7280; --line:#e5e7eb; --brand:#4f46e5; --brand-2:#7c3aed;
      --chip-open:#ef4444; --chip-prog:#0284c7; --chip-done:#16a34a;
      --shadow:0 10px 20px rgba(0,0,0,.06); --radius:14px;

      --secondary-bg:#f1f5f9;
      --secondary-text:#111827;
      --secondary-border:#d1d5db;
      --secondary-hover:#e5e7eb;
    }
    .wrap{max-width:1100px;margin:0 auto;}
    .page-head{margin-bottom:18px;}
    .title h2{margin:0;font-weight:800}
    .muted{color:var(--muted)}
    .card{background:var(--card-bg);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .card-head{padding:16px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px}
    .card .card-body{padding:18px}
    .card .card-foot{padding:12px 18px;border-top:1px solid var(--line);background:#fafafa;border-bottom-left-radius:var(--radius);border-bottom-right-radius:var(--radius)}
    .btn{display:inline-flex;gap:8px;align-items:center;padding:10px 14px;border-radius:12px;border:1px solid var(--line);background:#fff;cursor:pointer;text-decoration:none}
    .btn.primary{background:linear-gradient(135deg,var(--brand),var(--brand-2));color:#fff;border-color:transparent}
    .btn.secondary{background:var(--secondary-bg);color:var(--secondary-text);border-color:var(--secondary-border)}
    .btn.secondary:hover{background:var(--secondary-hover)}
    .form-row{display:flex;gap:12px;flex-wrap:wrap}
    .form-item{flex:1;min-width:260px}
    .form-item label{display:block;margin:8px 0 6px;font-weight:600}
    .input{width:100%;border:1px solid var(--line);background:#fff;border-radius:12px;padding:12px 14px;font:inherit;outline:none}
    .input:focus{border-color:var(--brand);box-shadow:0 0 0 4px rgba(79,70,229,.10)}
    .list{display:flex;flex-direction:column;gap:10px}
    .ticket{border:1px solid var(--line);background:#fff;border-radius:14px;padding:14px 16px;display:flex;justify-content:space-between;gap:12px}
    .ticket-title{font-weight:700;margin:0 0 6px}
    .meta{display:inline-flex;gap:6px;align-items:center;margin-right:14px;color:var(--muted);font-size:13px}
    .note{color:var(--muted);margin-top:6px}
    .filebox{display:flex;align-items:center;gap:12px}
    .thumb{width:84px;height:84px;border:1px dashed var(--line);border-radius:12px;display:flex;align-items:center;justify-content:center;overflow:hidden;background:#fafafa}
    .thumb img{max-width:100%;max-height:100%;object-fit:cover}
    .thumb-sm{width:110px;height:82px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fafafa;flex-shrink:0;}
    .thumb-sm img{width:100%;height:100%;object-fit:cover;display:block}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:12px}
    .chip.open{background:var(--chip-open)}
    .chip.prog{background:var(--chip-prog)}
    .chip.done{background:var(--chip-done)}
    .prio-badge{display:inline-flex;align-items:center;gap:4px;font-weight:700;font-size:12px;padding:3px 9px;border-radius:999px;color:#fff}
    .prio-normal{background:#6b7280}
    .prio-high{background:#f59e0b}
    .prio-urgent{background:#ef4444}
    .prio-badge .material-symbols-outlined{font-size:16px}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <span class="material-symbols-outlined">apartment</span>
        <span>Cổng Sinh viên KTX</span>
      </div>
      <nav class="menu">
        <a class="menu-item" data-keep-user href="./student.html">
          <span class="material-symbols-outlined">home</span><span>Trang chủ</span>
        </a>
        <a class="menu-item" data-keep-user href="./checkin.html">
          <span class="material-symbols-outlined">how_to_reg</span><span>Check-in/Check-out</span>
        </a>
        <a class="menu-item active" data-keep-user href="./report.html">
          <span class="material-symbols-outlined">report</span><span>Báo cáo sự cố</span>
        </a>
        <a class="menu-item" href="../common/login.html" onclick="ktxAuth.logoutCurrent(); return false;">
          <span class="material-symbols-outlined">logout</span><span>Đăng xuất</span>
        </a>
      </nav>
    </aside>

    <main class="main">
      <section class="wrap">
        <div class="page-head">
          <div class="title">
            <h2>Báo cáo sự cố</h2>
            <p class="muted">Đang dùng: <b data-current-username></b> (<span data-current-role></span>)</p>
          </div>
        </div>

        <!-- Form -->
        <article class="card" style="margin-bottom:16px">
          <div class="card-head">
            <span class="material-symbols-outlined">add</span><b>Tạo báo cáo mới</b>
          </div>
          <div class="card-body">
            <div class="form-row">
              <div class="form-item">
                <label>Tiêu đề</label>
                <input id="rp-title" class="input" placeholder="Ví dụ: Phòng 302 mất điện từ tối qua" />
              </div>
            </div>
            <div class="form-row" style="margin-top:10px">
              <div class="form-item" style="flex:1 1 100%">
                <label>Ảnh minh hoạ (tuỳ chọn)</label>
                <div class="filebox">
                  <div class="thumb" id="thumb"><span class="material-symbols-outlined">image</span></div>
                  <input id="rp-file" type="file" accept="image/*" />
                </div>
                <p class="muted" style="margin-top:6px;font-size:13px">
                  Có thể chụp bảng điện, vòi nước, thiết bị… để quản lý xử lý nhanh hơn (không bắt buộc).
                </p>
              </div>
            </div>
          </div>
          <div class="card-foot" style="display:flex;gap:10px;flex-wrap:wrap;justify-content:flex-end">
            <button id="btn-send" class="btn primary">
              <span class="material-symbols-outlined">send</span>Gửi báo cáo
            </button>
            <a class="btn secondary" data-keep-user href="./student.html">
              <span class="material-symbols-outlined">home</span>Trang chủ
            </a>
          </div>
        </article>

        <!-- Danh sách -->
        <article class="card">
          <div class="card-head">
            <span class="material-symbols-outlined">history</span><b>Sự cố của tôi</b>
          </div>
          <div class="card-body">
            <div class="list" id="my-list"><p class="muted">Đang tải...</p></div>
          </div>
        </article>
      </section>
    </main>
  </div>

  <script src="../common/script.js"></script>
  <script>
    ktxAuth.requireAuth(["student"]);

    const fileInp = document.getElementById("rp-file");
    const thumb = document.getElementById("thumb");

    fileInp.addEventListener("change", () => {
      const f = fileInp.files?.[0];
      thumb.innerHTML = f ? `<img src="${URL.createObjectURL(f)}" alt="preview"/>` : '<span class="material-symbols-outlined">image</span>';
    });

    document.getElementById("btn-send").addEventListener("click", async () => {
      const title = document.getElementById("rp-title").value.trim();
      if (!title) return alert("Vui lòng nhập tiêu đề.");

      const btn = document.getElementById("btn-send");
      btn.disabled = true;
      btn.innerHTML = '<span class="material-symbols-outlined">hourglass_top</span>Đang gửi...';

      try {
        let image_url = null;
        const f = fileInp.files?.[0];
        if (f && typeof ktxAuth.apiUploadImage === "function") {
          image_url = await ktxAuth.apiUploadImage(f);
        }

        await ktxAuth.apiCreateReport({ title, description:null, category:null, priority:null, image_url });
        document.getElementById("rp-title").value = "";
        fileInp.value = "";
        thumb.innerHTML = '<span class="material-symbols-outlined">image</span>';
        await loadMine();
        alert("✅ Đã gửi báo cáo!");
      } catch (err) {
        alert("Gửi thất bại: " + (err.message || err));
      } finally {
        btn.disabled = false;
        btn.innerHTML = '<span class="material-symbols-outlined">send</span>Gửi báo cáo';
      }
    });

    async function loadMine() {
      const box = document.getElementById("my-list");
      box.innerHTML = '<p class="muted">Đang tải...</p>';
      try {
        const data = await ktxAuth.apiListReportsMine();
        if (!data || data.length === 0) {
          box.innerHTML = '<p class="muted">Bạn chưa có báo cáo nào.</p>';
          return;
        }

        box.innerHTML = data.map(r => {
          const st = r.status==='resolved'?['Đã giải quyết','done']:
                     r.status==='in_progress'?['Đang xử lý','prog']:['Mở','open'];
          const prMap={normal:{text:'Bình thường',cls:'prio-normal',icon:'schedule'},
                       high:{text:'Cao',cls:'prio-high',icon:'warning'},
                       urgent:{text:'Khẩn cấp',cls:'prio-urgent',icon:'whatshot'}};
          const pr=prMap[r.priority||'normal'];
          const img=r.image_url?`<a href="${r.image_url}" target="_blank" class="thumb-sm"><img src="${r.image_url}" alt="Ảnh sự cố"></a>`:"";
          return `
          <div class="ticket">
            <div style="display:flex;gap:14px;align-items:flex-start;flex:1">
              ${img}
              <div style="flex:1">
                <div class="ticket-title">${r.title}</div>
                <div class="meta"><span class="material-symbols-outlined" style="font-size:18px">schedule</span>${new Date(r.created_at).toLocaleString()}</div>
                <div class="meta">
                  ${r.category?`<span class="meta"><span class="material-symbols-outlined" style="font-size:18px">sell</span>${r.category}</span>`:""}
                  <span class="prio-badge ${pr.cls}"><span class="material-symbols-outlined">${pr.icon}</span>${pr.text}</span>
                </div>
                ${r.admin_reply?`<div class="note"><b>Phản hồi QL:</b> ${r.admin_reply}</div>`:""}
              </div>
            </div>
            <div><span class="chip ${st[1]}">${st[0]}</span></div>
          </div>`;
        }).join("");
      } catch (err) {
        box.innerHTML = `<p class="muted">Lỗi tải dữ liệu: ${err.message || err}</p>`;
      }
    }

    document.addEventListener("DOMContentLoaded", () => loadMine());
  </script>
</body>
</html>
