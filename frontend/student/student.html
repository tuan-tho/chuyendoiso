<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>C·ªïng Sinh vi√™n KTX ‚Äì Trang ch·ªß</title>

  <!-- Font & Icon -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600" rel="stylesheet" />
  <link rel="stylesheet" href="./student.css" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --card-bg:#fff; --muted:#6b7280; --line:#e5e7eb;
      --brand:#4f46e5; --brand-2:#7c3aed;
      --chip-open:#ef4444; --chip-prog:#0284c7; --chip-done:#16a34a;
      --shadow:0 10px 20px rgba(0,0,0,.06); --radius:14px;
      --secondary-bg:#f1f5f9; --secondary-text:#111827;
      --secondary-border:#d1d5db; --secondary-hover:#e5e7eb;
    }

    html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; background:#fafafa;}
    .app { min-height: 100%; display: flex; }

    .sidebar {
      position: fixed; top: 0; left: 0; bottom: 0;
      width: 270px; background: #fff;
      border-right: 1px solid var(--line);
      overflow-y: auto; z-index: 100;
    }
    .main { margin-left: 270px; width: calc(100% - 270px); }

    /* ===== Bi·ªÉu ƒë·ªì to h∆°n ===== */
    .chart-wrap.small-chart { display:flex; align-items:center; gap:18px; }
    .small-chart canvas { width:180px !important; height:180px !important; }
    .small-chart .chart-legend { font-size:14px; line-height:1.5; }

    .legend-item{ display:flex; align-items:center; gap:8px; }
    .legend-color{ width:12px; height:12px; border-radius:3px; }

    /* ===== Th·∫ª s·ª± c·ªë ===== */
    .list{display:flex;flex-direction:column;gap:10px}
    .ticket{border:1px solid var(--line);background:#fff;border-radius:14px;padding:14px 16px;display:flex;justify-content:space-between;gap:12px;position:relative}
    .ticket-title{font-weight:700;margin:0 0 6px}
    .meta{display:inline-flex;gap:6px;align-items:center;margin-right:14px;color:var(--muted);font-size:13px}
    .note{color:var(--muted);margin-top:6px}
    .thumb-sm{width:110px;height:82px;border:1px solid var(--line);border-radius:10px;overflow:hidden;background:#fafafa;flex-shrink:0;}
    .thumb-sm img{width:100%;height:100%;object-fit:cover;display:block}

    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;color:#fff;font-weight:700;font-size:12px}
    .chip.open{background:var(--chip-open)}
    .chip.prog{background:var(--chip-prog)}
    .chip.done{background:var(--chip-done)}

    .prio-badge{display:inline-flex;align-items:center;gap:4px;font-weight:700;font-size:12px;padding:3px 9px;border-radius:999px;color:#fff}
    .prio-normal{background:#6b7280}
    .prio-high{background:#f59e0b}
    .prio-urgent{background:#ef4444}
    .prio-badge .material-symbols-outlined{font-size:16px}

    /* ===== N√∫t h√†nh ƒë·ªông ===== */
    .btn {
      display:inline-block;
      text-decoration:none !important; /* üö´ B·ªè g·∫°ch ch√¢n */
      font-weight:600;
      border-radius:10px;
      padding:8px 14px;
      transition:0.2s;
    }

    /* N√∫t check-in/out xanh d∆∞∆°ng d·ªÖ nh√¨n */
    .btn.checkin {
      background: linear-gradient(135deg, #3b82f6, #60a5fa);
      color: white !important;
      border: none;
      box-shadow: 0 3px 10px rgba(59,130,246,0.25);
    }
    .btn.checkin:hover { filter: brightness(1.05); }

    /* N√∫t b√°o c√°o s·ª± c·ªë t√≠m */
    .btn.primary {
      background: linear-gradient(135deg, #6366f1, #8b5cf6);
      color: white !important;
      border: none;
      box-shadow: 0 3px 10px rgba(99,102,241,0.25);
    }
    .btn.primary:hover { filter: brightness(1.05); }
  </style>
</head>

<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand">
        <span class="material-symbols-outlined">apartment</span>
        <span>C·ªïng Sinh vi√™n KTX</span>
      </div>
      <nav class="menu">
        <a class="menu-item active" data-keep-user href="./student.html">
          <span class="material-symbols-outlined">home</span><span>Trang ch·ªß</span>
        </a>
        <a class="menu-item" data-keep-user href="./profile.html">
          <span class="material-symbols-outlined">badge</span><span>H·ªì s∆° c√° nh√¢n</span>
        </a>
        <a class="menu-item" data-keep-user href="./checkin.html">
          <span class="material-symbols-outlined">how_to_reg</span><span>Check-in/Check-out</span>
        </a>
        <a class="menu-item" data-keep-user href="./report.html">
          <span class="material-symbols-outlined">report</span><span>B√°o c√°o s·ª± c·ªë</span>
        </a>
        <a class="menu-item" href="../common/login.html" onclick="ktxAuth.logoutCurrent(); return false;">
          <span class="material-symbols-outlined">logout</span><span>ƒêƒÉng xu·∫•t</span>
        </a>
      </nav>
    </aside>

    <main class="main">
      <header class="topbar">
        <div class="welcome">
          <h2 class="hello">Xin ch√†o, <span id="hello-name" data-current-username></span> üëã</h2>
          <p class="muted">Vai tr√≤: <b data-current-role></b></p>
        </div>

        <!-- Hai n√∫t h√†nh ƒë·ªông v·ªõi m√†u ph√¢n bi·ªát -->
        <div class="top-actions" style="display:flex;gap:10px;flex-wrap:wrap;">
          <a class="btn checkin" data-keep-user href="./checkin.html">Check-in/Check-out</a>
          <a class="btn primary" data-keep-user href="./report.html">B√°o c√°o s·ª± c·ªë m·ªõi</a>
        </div>
      </header>

      <section class="content">
        <div class="grid quick-3">
          <!-- Ph√≤ng ·ªü -->
          <article class="card student-quick">
            <div class="sq-head"><span class="material-symbols-outlined">location_home</span><h3>Th√¥ng tin ph√≤ng ·ªü</h3></div>
            <div class="kv slim">
              <div><span>T√≤a</span><b id="q_building">KSSV</b></div>
              <div><span>Ph√≤ng</span><b id="q_room">‚Äî</b></div>
              <div><span>Gi∆∞·ªùng</span><b id="q_bed">‚Äî</b></div>
            </div>
          </article>

          <!-- Bi·ªÉu ƒë·ªì s·ª± c·ªë -->
          <article class="card student-quick">
            <div class="sq-head"><span class="material-symbols-outlined">query_stats</span><h3>Th·ªëng k√™ s·ª± c·ªë</h3></div>
            <div class="chart-wrap small-chart">
              <canvas id="reportChart" width="180" height="180"></canvas>
              <div class="chart-legend" id="chartLegend"></div>
            </div>
          </article>

          <!-- ƒêi·ªán n∆∞·ªõc -->
          <article class="card student-quick">
            <div class="sq-head"><span class="material-symbols-outlined">bolt</span><h3>S·ªë d∆∞ ƒëi·ªán n∆∞·ªõc</h3></div>
            <div class="balance">
              <div class="bal-item"><span>ƒêi·ªán</span><b>72 kWh</b><small class="muted">C√≤n ~9 ng√†y</small></div>
              <div class="bal-item"><span>N∆∞·ªõc</span><b>8 m¬≥</b><small class="muted">C√≤n ~12 ng√†y</small></div>
            </div>
          </article>
        </div>

        <!-- S·ª± c·ªë c·ªßa t√¥i -->
        <section class="card my-incidents">
          <div class="mi-head" style="padding:14px 0 14px 18px;border-bottom:1px solid var(--line);display:flex;align-items:center;gap:8px;justify-content:flex-start">
            <span class="material-symbols-outlined" style="font-size:22px;color:#4f46e5">history</span>
            <b style="font-size:16px;color:#111827">S·ª± c·ªë c·ªßa t√¥i</b>
          </div>
          <div class="card-body">
            <div class="list" id="ticket-list"><p class="muted">ƒêang t·∫£i...</p></div>
          </div>
        </section>
      </section>
    </main>
  </div>

  <script src="../common/script.js"></script>
  <script>
  document.addEventListener('DOMContentLoaded', async () => {
    ktxAuth.requireAuth(["student"]);
    const u = ktxAuth.getCurrentUsername();
    const key = `ktx:profile:${u}`;

    const hello=document.getElementById("hello-name");
    function paintQuick(p,uinfo){
      const building=p?.building?.trim()||"KSSV";
      const room=uinfo?.room||p?.room||"‚Äî";
      const bed=p?.bed||"‚Äî";
      document.getElementById("q_building").textContent=building;
      document.getElementById("q_room").textContent=room;
      document.getElementById("q_bed").textContent=bed;
      hello.textContent=p?.full_name||uinfo?.full_name||uinfo?.username||"b·∫°n";
    }

    if(u){
      const cache=localStorage.getItem(key);
      if(cache){try{const d=JSON.parse(cache);paintQuick(d,{room:d.room,full_name:d.full_name});}catch{}}
    }

    try{
      const [rp,ru]=await Promise.all([ktxAuth.apiFetch("/profile/me"),ktxAuth.apiFetch("/users/me")]);
      if(rp.ok&&ru.ok){
        const [p,uinfo]=[await rp.json(),await ru.json()];
        paintQuick(p,uinfo);
        localStorage.setItem(key,JSON.stringify({...p,room:uinfo.room,full_name:uinfo.full_name}));
      }
    }catch{}

    const ctx=document.getElementById('reportChart').getContext('2d');
    let chart;
    function drawChart(stats){
      const labels=['M·ªü','ƒêang x·ª≠ l√Ω','ƒê√£ gi·∫£i quy·∫øt'];
      const data=[stats.open,stats.in_progress,stats.resolved];
      const colors=['#ef4444','#3b82f6','#10b981'];
      if(chart)chart.destroy();
      chart=new Chart(ctx,{
        type:'doughnut',
        data:{labels,datasets:[{data,backgroundColor:colors,borderWidth:0}]},
        options:{responsive:true,plugins:{legend:{display:false}},cutout:'55%'}
      });
      const lg=document.getElementById('chartLegend');
      lg.innerHTML=labels.map((lb,i)=>`<div class="legend-item"><span class="legend-color" style="background:${colors[i]}"></span>${lb}: <b>${data[i]}</b></div>`).join('');
    }

    const escapeHTML = (s='') => String(s)
      .replaceAll('&','&amp;').replaceAll('<','&lt;')
      .replaceAll('>','&gt;').replaceAll('"','&quot;')
      .replaceAll("'","&#039;");
    const prMap={normal:{text:'B√¨nh th∆∞·ªùng',cls:'prio-normal',icon:'schedule'},
                 high:{text:'Cao',cls:'prio-high',icon:'warning'},
                 urgent:{text:'Kh·∫©n c·∫•p',cls:'prio-urgent',icon:'whatshot'}};
    const statusMap = (s) => s==='resolved'?['ƒê√£ gi·∫£i quy·∫øt','done']
                               :(s==='in_progress'?['ƒêang x·ª≠ l√Ω','prog']:['M·ªü','open']);
    const box=document.getElementById('ticket-list');
    box.innerHTML='<p class="muted">ƒêang t·∫£i...</p>';

    try{
      const data=await ktxAuth.apiListReportsMine();
      if(!Array.isArray(data)||data.length===0){
        box.innerHTML='<p class="muted">B·∫°n ch∆∞a c√≥ b√°o c√°o n√†o.</p>';
      }else{
        box.innerHTML=data.map(r=>{
          const [stText, stCls] = statusMap(r.status);
          const pr = prMap[(r.priority||'normal')];
          const category = r.category ?? r.label ?? null;
          const img = r.image_url ? `<a href="${r.image_url}" target="_blank" class="thumb-sm"><img src="${r.image_url}" alt="·∫¢nh s·ª± c·ªë"></a>` : "";
          const adminReply = r.admin_reply ?? r.admin_response ?? r.response ?? r.reply ?? null;

          return `
          <div class="ticket">
            <div style="display:flex;gap:14px;align-items:flex-start;flex:1">
              ${img}
              <div style="flex:1">
                <div class="ticket-title">${escapeHTML(r.title||'')}</div>
                <div class="meta">
                  <span class="material-symbols-outlined" style="font-size:18px">schedule</span>
                  ${r.created_at ? new Date(r.created_at).toLocaleString('vi-VN') : ''}
                </div>
                <div class="meta">
                  ${category ? `<span class="meta"><span class="material-symbols-outlined" style="font-size:18px">sell</span>${escapeHTML(category)}</span>` : ``}
                  <span class="prio-badge ${pr.cls}"><span class="material-symbols-outlined">${pr.icon}</span>${pr.text}</span>
                </div>
                ${adminReply ? `<div class="note"><b>Ph·∫£n h·ªìi QL:</b> ${escapeHTML(adminReply)}</div>` : ``}
              </div>
            </div>
            <div><span class="chip ${stCls}">${stText}</span></div>
          </div>`;
        }).join('');
      }

      const stats={open:0,in_progress:0,resolved:0};
      (data||[]).forEach(r=>{
        if(r.status==='resolved') stats.resolved++;
        else if(r.status==='in_progress') stats.in_progress++;
        else stats.open++;
      });
      drawChart(stats);
    }catch(err){
      box.innerHTML = `<p class="muted">Kh√¥ng t·∫£i ƒë∆∞·ª£c d·ªØ li·ªáu: ${escapeHTML(err?.message||String(err))}</p>`;
    }
  });
  </script>
</body>
</html>
