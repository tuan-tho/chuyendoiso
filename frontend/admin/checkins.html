<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Y√™u c·∫ßu Check-in/Check-out ‚Äì KTX-DNU</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600" rel="stylesheet" />
  <link rel="stylesheet" href="../student/student.css" />

  <style>
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .table { width:100%; border-collapse: collapse; background:#fff; border-radius:12px; overflow:hidden; }
    .table th, .table td { padding:12px 10px; border-bottom: 1px solid #eef2f7; text-align:left; vertical-align: top; }
    .table th { background:#f8fafc; font-weight:600; }
    .card { background:#fff; border:1px solid #e5e7eb; border-radius:12px; padding:16px; }

    .filters { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:14px; flex-wrap:wrap; }
    .tabs { display:flex; gap:8px; }
    .btn { display:inline-flex; align-items:center; gap:6px; padding:8px 12px; border-radius:10px; border:1px solid #e5e7eb; background:#fff; cursor:pointer; font-weight:600; }
    .btn:hover { background:#f8fafc; }
    .btn.tab { background:#fff; }
    .btn.tab.active { background:#4f46e5; color:#fff; border-color:#4f46e5; }

    .search { display:flex; align-items:center; gap:8px; border:1px solid #e5e7eb; border-radius:999px; padding:8px 12px; background:#fff; }
    .search .material-symbols-outlined { font-size:18px; color:#6b7280; }
    .search input { border:none; outline:none; min-width:280px; font-size:14px; }
    .search input::placeholder { color:#9ca3af; }

    .chip { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; border-radius:999px; font-weight:700; font-size:12px; }
    .chip.info { background:#e0f2fe; color:#075985; }
    .chip.success { background:#dcfce7; color:#166534; }
    .chip.danger { background:#fee2e2; color:#b91c1c; }

    .toolbar { display:flex; gap:6px; flex-wrap:wrap; }
    .btn.sm { padding:6px 10px; border-radius:8px; font-weight:600; }
    .btn.ghost { background:#fff; }
    .note { color:#6b7280; font-size:12px; margin-top:6px; }
    .muted { color:#6b7280; }

    /* üëá th√™m style thumbnail ·∫£nh */
    .thumb-sm{width:110px;height:82px;border:1px solid #e5e7eb;border-radius:10px;overflow:hidden;background:#fafafa;display:block}
    .thumb-sm img{width:100%;height:100%;object-fit:cover;display:block}
  </style>
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="brand">
      <span class="material-symbols-outlined">apartment</span>
      <span>KSSV-DNU</span>
    </div>
    <nav class="menu">
      <a class="menu-item" data-keep-user href="./admin.html">
        <span class="material-symbols-outlined">dashboard</span><span>Trang qu·∫£n l√Ω</span>
      </a>
      <a class="menu-item" data-keep-user href="./report_manage.html">
        <span class="material-symbols-outlined">report</span><span>Qu·∫£n l√Ω s·ª± c·ªë</span>
      </a>
      <a class="menu-item active" data-keep-user href="./checkins.html">
        <span class="material-symbols-outlined">how_to_reg</span><span>Check-in/Check-out</span>
      </a>
      <a class="menu-item" data-keep-user href="./users.html">
        <span class="material-symbols-outlined">group</span><span>Qu·∫£n l√Ω t√†i kho·∫£n</span>
      </a>
      <a class="menu-item" href="../common/login.html" onclick="ktxAuth.logoutCurrent(); return false;">
        <span class="material-symbols-outlined">logout</span><span>ƒêƒÉng xu·∫•t</span>
      </a>
    </nav>
  </aside>

  <!-- Main -->
  <main class="main">
    <header class="topbar">
      <div class="welcome wrap">
        <h2 class="hello">Y√™u c·∫ßu Check-in/Check-out</h2>
        <p class="muted">ƒêang d√πng: <b data-current-username></b> (<span data-current-role></span>)</p>
      </div>
    </header>

    <section class="content wrap">
      <div class="card">
        <div class="filters">
          <div class="tabs" id="tabs">
            <button class="btn tab active" data-filter="all">T·∫•t c·∫£</button>
            <button class="btn tab" data-filter="pending">ƒêang ch·ªù</button>
            <button class="btn tab" data-filter="approved">ƒê√£ duy·ªát</button>
            <button class="btn tab" data-filter="rejected">T·ª´ ch·ªëi</button>
          </div>

          <label class="search">
            <span class="material-symbols-outlined">search</span>
            <input id="search" type="text" placeholder="T√¨m ki·∫øm..." />
          </label>
        </div>

        <div id="list">ƒêang t·∫£i...</div>
      </div>
    </section>
  </main>
</div>

<script src="../common/script.js"></script>
<script>
(() => {
  if (window.KTXCheckins) return;
  window.KTXCheckins = true;

  ktxAuth.requireAuth(["admin"]);

  const me = ktxAuth.getUser();
  if (me) {
    document.querySelector("[data-current-username]").textContent = me.username || "";
    document.querySelector("[data-current-role]").textContent = me.role || "";
  }

  const CANDIDATES = ["/checkins/checkins", "/checkins"];
  let CHECKINS_PATH = null;
  let rawData = [];
  let currentFilter = "all";

  const listBox = document.getElementById("list");
  const tabsWrap = document.getElementById("tabs");
  const searchBox = document.getElementById("search");

  const normalize = (v) => String(v ?? "")
    .toLowerCase()
    .normalize("NFD").replace(/\p{Diacritic}/gu,"")
    .trim();

  const stripZero = (s) => String(s ?? "").replace(/^0+/, "") || "0";

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
  }

  // üëá helper: chu·∫©n ho√° URL ·∫£nh (n·∫øu backend tr·∫£ path t∆∞∆°ng ƒë·ªëi)
  function resolveImg(url){
    if(!url) return null;
    return url.startsWith('http') ? url : (window.ktxAuth.apiBase + url);
  }

  async function ensurePath() {
    if (CHECKINS_PATH) return CHECKINS_PATH;
    for (const p of CANDIDATES) {
      try {
        const r = await ktxAuth.apiFetch(p);
        if (r.ok) { CHECKINS_PATH = p; return p; }
      } catch {}
    }
    throw new Error("Kh√¥ng t√¨m th·∫•y endpoint danh s√°ch.");
  }

  async function loadData() {
    listBox.textContent = "ƒêang t·∫£i...";
    try {
      await ensurePath();
      const res = await ktxAuth.apiFetch(CHECKINS_PATH);
      if (!res.ok) throw new Error(`HTTP ${res.status}: ` + (await res.text()));
      rawData = await res.json();
      render();
    } catch (e) {
      listBox.innerHTML = `<p class="muted">L·ªói t·∫£i d·ªØ li·ªáu: ${escapeHtml(e.message)}</p>`;
      console.error(e);
    }
  }

  // --- T√¨m ki·∫øm ---
  function applySearch(data){
    const qRaw = (searchBox.value || "").trim();
    if (!qRaw) return data;

    const norm = (v) => String(v ?? "")
      .toLowerCase()
      .normalize("NFD").replace(/\p{Diacritic}/gu,"")
      .trim();

    const stripZero = (s) => String(s ?? "").replace(/^0+/, "") || "0";
    const tokens = norm(qRaw).split(/\s+/).filter(Boolean);

    const preds = tokens.map(tok => {
      if (tok.startsWith("sv")) {
        let rest = tok.slice(2);
        if (rest.startsWith(":") || rest.startsWith("-")) rest = rest.slice(1);
        if (rest.startsWith("sv")) rest = rest.slice(2);
        rest = rest.trim();
        if (rest.startsWith("sv")) rest = rest.slice(2);
        const isNum = /^\d+$/.test(rest);

        return (x) => {
          const sid  = stripZero( String(x.student_id ?? x.student?.id ?? "") );
          const uname = norm(x.student?.username ?? x.username ?? x.user?.username ?? "");
          if (isNum) return sid === stripZero(rest);
          const r1 = rest;
          const r2 = rest.startsWith("sv") ? rest : ("sv" + rest);
          return uname === r1 || uname === r2;
        };
      }

      return (x) => {
        const blob = norm([
          x.student_id, x.student?.username, x.student?.full_name,
          x.type, x.status, x.admin_reply, x.date, x.time
        ].join(" "));
        return blob.includes(tok);
      };
    });

    return data.filter(item => preds.every(fn => fn(item)));
  }

  function applyTabFilter(data){
    if (currentFilter === "all") return data;
    return data.filter(x => (x.status || "pending") === currentFilter);
  }

  function render(){
    let data = (rawData || []).slice().sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
    data = applyTabFilter(data);
    data = applySearch(data);

    if (!data.length){
      listBox.innerHTML = `<p class="muted">Kh√¥ng c√≥ y√™u c·∫ßu ph√π h·ª£p.</p>`;
      return;
    }

    const rows = data.map(x => {
      // üëá L·∫•y text hi·ªÉn th·ªã cho c·ªôt Sinh vi√™n (∆∞u ti√™n: m√£ SV -> username -> fallback id)
      const svText =
        (x.student?.student_code) ??
        (x.student?.username) ??
        (x.username) ??
        (x.user?.username) ??
        (x.student_id ?? "-");

      const img = x.image_url
        ? `<a href="${resolveImg(x.image_url)}" target="_blank" class="thumb-sm"><img src="${resolveImg(x.image_url)}" alt="·∫¢nh"></a>`
        : '';

      return `
      <tr>
        <td><b>${escapeHtml((x.type||'').toUpperCase())}</b></td>
        <td>${escapeHtml(x.date || '')} ${escapeHtml(x.time || '')}</td>
        <td>SV: ${escapeHtml(svText)}</td>
        <td>${img}</td>
        <td>
          <span class="chip ${
            x.status==='approved'?'success':x.status==='rejected'?'danger':'info'
          }">${escapeHtml(x.status || 'pending')}</span>
          ${x.admin_reply ? `<div class="note">Ph·∫£n h·ªìi: ${escapeHtml(x.admin_reply)}</div>` : ''}
        </td>
        <td class="toolbar">
          <button class="btn sm" onclick="KTX_setStatus(${x.id}, 'approved')">Duy·ªát</button>
          <button class="btn sm" onclick="KTX_setStatus(${x.id}, 'rejected')">T·ª´ ch·ªëi</button>
          <button class="btn sm ghost" onclick="KTX_setStatus(${x.id}, 'pending')">V·ªÅ pending</button>
          <button class="btn sm ghost" onclick="KTX_reply(${x.id}, ${JSON.stringify(x.admin_reply||'')})">Ph·∫£n h·ªìi</button>
        </td>
        <td>${x.created_at ? new Date(x.created_at).toLocaleString('vi-VN') : ''}</td>
      </tr>`;
    }).join('');

    listBox.innerHTML = `
      <div style="overflow:auto">
        <table class="table">
          <thead>
            <tr>
              <th>Lo·∫°i</th>
              <th>Ng√†y/Gi·ªù</th>
              <th>Sinh vi√™n</th>
              <th>·∫¢nh</th>
              <th>Tr·∫°ng th√°i</th>
              <th>Thao t√°c</th>
              <th>T·∫°o l√∫c</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      </div>
    `;
  }

  async function setStatus(id, status){
    try {
      await ensurePath();
      const admin_reply = prompt("Nh·∫≠p ghi ch√∫ ph·∫£n h·ªìi (c√≥ th·ªÉ b·ªè tr·ªëng):", "");
      const res = await ktxAuth.apiFetch(`${CHECKINS_PATH}/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ status, admin_reply: admin_reply || null })
      });
      if (!res.ok) throw new Error(await res.text());
      await loadData();
      alert('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i.');
    } catch (e) { alert('L·ªói: ' + e.message); }
  }

  async function reply(id, cur){
    try {
      await ensurePath();
      const admin_reply = prompt("Nh·∫≠p/ƒë·ªïi ph·∫£n h·ªìi cho y√™u c·∫ßu:", cur || "");
      if (admin_reply === null) return;
      const res = await ktxAuth.apiFetch(`${CHECKINS_PATH}/${id}`, {
        method: 'PATCH',
        body: JSON.stringify({ admin_reply })
      });
      if (!res.ok) throw new Error(await res.text());
      await loadData();
      alert('ƒê√£ l∆∞u ph·∫£n h·ªìi.');
    } catch (e) { alert('L·ªói: ' + e.message); }
  }

  window.KTX_setStatus = setStatus;
  window.KTX_reply = reply;

  tabsWrap.addEventListener("click", (e) => {
    const btn = e.target.closest("[data-filter]");
    if (!btn) return;
    tabsWrap.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    currentFilter = btn.dataset.filter;
    render();
  });

  let searchTimer = null;
  searchBox.addEventListener("input", () => {
    clearTimeout(searchTimer);
    searchTimer = setTimeout(render, 180);
  });

  document.addEventListener('DOMContentLoaded', loadData, { once: true });
})();
</script>
</body>
</html>
