<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£ng ƒëi·ªÅu khi·ªÉn Qu·∫£n l√Ω ‚Äì KTX-DNU</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600" rel="stylesheet" />
  <link rel="stylesheet" href="../student/student.css" />

  <style>
    html, body { height: 100%; margin: 0; }
    .app { min-height: 100%; display: flex; }

    /* === Sidebar c·ªë ƒë·ªãnh === */
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: 270px;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      overflow-y: auto;
      z-index: 100;
    }

    /* === N·ªôi dung ch√≠nh === */
    .main {
      margin-left: 270px;
      width: calc(100% - 270px);
      min-height: 100vh;
      overflow-y: auto;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <span class="material-symbols-outlined">apartment</span>
        <span>KTX-DNU</span>
      </div>
      <nav class="menu">
        <a class="menu-item active" data-keep-user href="./admin.html">
          <span class="material-symbols-outlined">dashboard</span><span>Trang qu·∫£n l√Ω</span>
        </a>

        <!-- Qu·∫£n l√Ω s·ª± c·ªë -->
        <a class="menu-item" data-keep-user href="./report_manage.html">
          <span class="material-symbols-outlined">report</span><span>Qu·∫£n l√Ω s·ª± c·ªë</span>
        </a>

        <!-- ‚úÖ Thay ‚ÄúTrang sinh vi√™n‚Äù b·∫±ng ‚ÄúCheck-in/Check-out‚Äù -->
        <a class="menu-item" data-keep-user href="./checkins.html">
          <span class="material-symbols-outlined">how_to_reg</span><span>Check-in/Check-out</span>
        </a>

        <!-- ƒêƒÉng xu·∫•t -->
        <a class="menu-item" href="../common/login.html" onclick="ktxAuth.logoutCurrent(); return false;">
          <span class="material-symbols-outlined">logout</span><span>ƒêƒÉng xu·∫•t</span>
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="welcome">
          <h2 class="hello">B·∫£ng ƒëi·ªÅu khi·ªÉn Qu·∫£n l√Ω</h2>
          <p class="muted">ƒêang d√πng: <b data-current-username></b> (<span data-current-role></span>)</p>
        </div>
      </header>

      <section class="content">
        <div class="grid quick-3">
          <article class="card">
            <h3><span class="material-symbols-outlined">assignment</span> B√°o c√°o m·ªõi</h3>
            <p class="muted">Xem & x·ª≠ l√Ω c√°c b√°o c√°o s·ª± c·ªë t·ª´ sinh vi√™n.</p>
            <a class="btn primary" data-keep-user href="./report_manage.html">
              <span class="material-symbols-outlined">open_in_new</span> M·ªü trang Qu·∫£n l√Ω s·ª± c·ªë
            </a>
          </article>

          <article class="card">
            <h3><span class="material-symbols-outlined">how_to_reg</span> Check-in/Check-out</h3>
            <p class="muted">Xem y√™u c·∫ßu v√†o/ra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i.</p>
            <a class="btn ghost" data-keep-user href="./checkins.html">
              <span class="material-symbols-outlined">list</span> Xem danh s√°ch
            </a>
          </article>
        </div>

        <!-- Danh s√°ch Check-in/Check-out -->
        <section class="card" id="checkins">
          <div class="mi-head">
            <h3><span class="material-symbols-outlined">history</span> Y√™u c·∫ßu Check-in/Check-out</h3>
          </div>
          <div id="ck-list" class="mi-list"></div>
        </section>
      </section>
    </main>
  </div>

  <script src="../common/script.js"></script>
  <script>
    // Ch·ªâ cho ph√©p admin truy c·∫≠p
    ktxAuth.requireAuth(["admin"]);

    async function updateCheckin(id, patch) {
      const res = await ktxAuth.apiFetch(`/checkins/${id}`, {
        method: "PATCH",
        body: JSON.stringify(patch),
      });
      if (!res.ok) throw new Error(`${res.status}`);
      return res.json();
    }

    async function approve(id) {
      try { await updateCheckin(id, { status: "approved" }); await loadCheckins(); alert("‚úÖ ƒê√£ duy·ªát y√™u c·∫ßu."); }
      catch (e) { alert("L·ªói: " + e.message); }
    }

    async function reject(id) {
      const note = prompt("Nh·∫≠p l√Ω do t·ª´ ch·ªëi (t√πy ch·ªçn):", "");
      try { await updateCheckin(id, { status: "rejected", admin_reply: note || null }); await loadCheckins(); alert("üö´ ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu."); }
      catch (e) { alert("L·ªói: " + e.message); }
    }

    async function reply(id) {
      const note = prompt("N·ªôi dung ph·∫£n h·ªìi:", "");
      if (note === null) return;
      try { await updateCheckin(id, { admin_reply: note }); await loadCheckins(); alert("üí¨ ƒê√£ ph·∫£n h·ªìi."); }
      catch (e) { alert("L·ªói: " + e.message); }
    }

    async function loadCheckins() {
      const box = document.getElementById('ck-list');
      box.innerHTML = '<p class="muted">ƒêang t·∫£i...</p>';
      try {
        const res = await ktxAuth.apiFetch('/checkins');
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          box.innerHTML = '<p class="muted">Ch∆∞a c√≥ y√™u c·∫ßu.</p>';
          return;
        }

        data.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
        box.innerHTML = data.map(item => {
          const chipCls = item.status === 'approved' ? 'success'
                        : item.status === 'rejected' ? 'danger' : 'info';
          const statusVN = item.status === 'approved' ? 'ƒê√£ duy·ªát'
                        : item.status === 'rejected' ? 'T·ª´ ch·ªëi' : 'ƒêang ch·ªù';
          return `
            <article class="ticket">
              <div class="ticket-main">
                <div class="ticket-title">${item.type.toUpperCase()} ‚Ä¢ ${item.date}${item.time ? ' ' + item.time : ''}</div>
                <div class="ticket-meta">
                  <span class="meta"><span class="material-symbols-outlined">person</span> SV ID: ${item.student_id}</span>
                  <span class="meta"><span class="material-symbols-outlined">schedule</span> ${new Date(item.created_at).toLocaleString('vi-VN')}</span>
                  ${item.note ? `<span class="meta"><span class="material-symbols-outlined">notes</span> ${item.note}</span>` : ''}
                </div>
              </div>
              <div class="ticket-aside" style="display:flex;gap:8px;align-items:center">
                <span class="chip ${chipCls}">${statusVN}</span>
                <button class="btn ghost sm" onclick="reply(${item.id})">
                  <span class="material-symbols-outlined">chat</span> Ph·∫£n h·ªìi
                </button>
                ${item.status !== 'approved' ? `
                  <button class="btn primary sm" onclick="approve(${item.id})">
                    <span class="material-symbols-outlined">check</span> Duy·ªát
                  </button>` : ''}
                ${item.status !== 'rejected' ? `
                  <button class="btn ghost sm" onclick="reject(${item.id})">
                    <span class="material-symbols-outlined">close</span> T·ª´ ch·ªëi
                  </button>` : ''}
              </div>
            </article>
          `;
        }).join('');
      } catch (e) {
        box.innerHTML = `<p class="muted">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</p>`;
      }
    }

    document.addEventListener('DOMContentLoaded', loadCheckins);
  </script>
</body>
</html>
