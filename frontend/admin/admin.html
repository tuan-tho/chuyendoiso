<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£ng ƒëi·ªÅu khi·ªÉn Qu·∫£n l√Ω ‚Äì KTX-DNU</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@300;400;600" rel="stylesheet" />
  <link rel="stylesheet" href="../student/student.css" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    html, body { height: 100%; margin: 0; font-family: 'Inter', sans-serif; }
    .app { min-height: 100%; display: flex; }

    /* Sidebar c·ªë ƒë·ªãnh */
    .sidebar {
      position: fixed;
      top: 0; left: 0; bottom: 0;
      width: 270px;
      background: #fff;
      border-right: 1px solid #e5e7eb;
      overflow-y: auto;
      z-index: 100;
    }

    /* Main content */
    .main {
      margin-left: 270px;
      width: calc(100% - 270px);
      min-height: 100vh;
      overflow-y: auto;
      padding-bottom: 30px;
    }

    /* N√∫t */
    .btn {
      text-decoration: none !important;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: 500;
      border-radius: 8px;
      padding: 8px 14px;
      transition: 0.2s;
      gap: 8px;
    }
    .btn.primary { background:#6366f1; color:#fff; }
    .btn.primary:hover { background:#4f46e5; }
    .btn.purple { background:#7c3aed; color:#fff; }
    .btn.purple:hover { background:#6d28d9; }
    .btn.sm { padding:6px 10px; border-radius:8px; }

    /* L∆∞·ªõi 2 c·ªôt cho 2 chart ƒë·∫ßu */
    .wrap { max-width: 1100px; margin: 0 auto; padding: 0 16px; }
    .grid-2 {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }

    .legend-dot {
      display:inline-block;width:12px;height:12px;border-radius:9999px;
      margin-right:6px;vertical-align:middle;
    }

    h3 { display: flex; align-items: center; gap: 6px; margin-bottom: 10px; }

    /* ‚úÖ Gi·∫£m k√≠ch th∆∞·ªõc bi·ªÉu ƒë·ªì 2 card tr√™n */
    .card canvas {
      max-width: 80%;
      height: auto !important;
      margin: 0 auto;
      display: block;
    }
  </style>
</head>

<body>
  <div class="app">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="brand">
        <span class="material-symbols-outlined">apartment</span>
        <span>KSSV-DNU</span>
      </div>
      <nav class="menu">
        <a class="menu-item active" data-keep-user href="./admin.html">
          <span class="material-symbols-outlined">dashboard</span><span>Trang qu·∫£n l√Ω</span>
        </a>
        <a class="menu-item" data-keep-user href="./report_manage.html">
          <span class="material-symbols-outlined">report</span><span>Qu·∫£n l√Ω s·ª± c·ªë</span>
        </a>
        <a class="menu-item" data-keep-user href="./checkins.html">
          <span class="material-symbols-outlined">how_to_reg</span><span>Check-in/Check-out</span>
        </a>
        <a class="menu-item" data-keep-user href="./users.html">
          <span class="material-symbols-outlined">group</span><span>Qu·∫£n l√Ω t√†i kho·∫£n</span>
        </a>

        <a class="menu-item" href="../common/login.html" onclick="ktxAuth.logoutCurrent(); return false;">
          <span class="material-symbols-outlined">logout</span><span>ƒêƒÉng xu·∫•t</span>
        </a>
      </nav>
    </aside>

    <!-- Main -->
    <main class="main">
      <header class="topbar">
        <div class="welcome wrap">
          <h2 class="hello">B·∫£ng ƒëi·ªÅu khi·ªÉn Qu·∫£n l√Ω</h2>
          <p class="muted">ƒêang d√πng: <b data-current-username></b> (<span data-current-role></span>)</p>
        </div>
      </header>

      <section class="content wrap">
        <!-- H√†ng 1: 2 card ch·ª©c nƒÉng -->
        <div class="grid-2" style="margin-top:10px">
          <article class="card">
            <h3><span class="material-symbols-outlined">assignment</span> B√°o c√°o m·ªõi</h3>
            <p class="muted">Xem & x·ª≠ l√Ω c√°c b√°o c√°o s·ª± c·ªë t·ª´ sinh vi√™n.</p>
            <a class="btn primary" data-keep-user href="./report_manage.html">M·ªü trang Qu·∫£n l√Ω s·ª± c·ªë</a>
          </article>

          <article class="card">
            <h3><span class="material-symbols-outlined">how_to_reg</span> Check-in/Check-out</h3>
            <p class="muted">Xem y√™u c·∫ßu v√†o/ra v√† c·∫≠p nh·∫≠t tr·∫°ng th√°i.</p>
            <a class="btn purple" data-keep-user href="./checkins.html">Xem danh s√°ch</a>
          </article>
        </div>

        <!-- H√†ng 2: 2 bi·ªÉu ƒë·ªì -->
        <div class="grid-2" style="margin-top:20px">
          <article class="card">
            <h3>Ph√¢n b·ªë m·ª©c ƒë·ªô ∆∞u ti√™n</h3>
            <canvas id="priorityChart" width="280" height="160"></canvas>
            <div class="muted" style="margin-top:10px;display:flex;gap:16px;flex-wrap:wrap">
              <span><span class="legend-dot" style="background:#93c5fd"></span> B√¨nh th∆∞·ªùng</span>
              <span><span class="legend-dot" style="background:#f59e0b"></span> Cao</span>
              <span><span class="legend-dot" style="background:#ef4444"></span> Kh·∫©n c·∫•p</span>
            </div>
          </article>

          <article class="card">
            <h3>T√¨nh h√¨nh Check-in / Check-out</h3>
            <canvas id="checkChart" width="280" height="160"></canvas>
            <div class="muted" style="margin-top:10px;display:flex;gap:16px;flex-wrap:wrap">
              <span><span class="legend-dot" style="background:#22c55e"></span> Check-in</span>
              <span><span class="legend-dot" style="background:#3b82f6"></span> Check-out</span>
            </div>
          </article>
        </div>

        <!-- H√†ng 3: Bi·ªÉu ƒë·ªì th·ªëng k√™ theo Lo·∫°i (FULL WIDTH ‚Äì d√πng d·ªØ li·ªáu th·∫≠t t·ª´ /reports) -->
        <article class="card" style="margin-top:20px">
          <h3><span class="material-symbols-outlined">bar_chart_4_bars</span> Th·ªëng k√™ theo <b>lo·∫°i s·ª± c·ªë</b></h3>
          <canvas id="categoryChart" height="220"></canvas>
          <div id="catEmpty" class="muted" style="display:none;margin-top:8px">Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ th·ªëng k√™.</div>
        </article>

        <!-- Danh s√°ch Check-in/Check-out -->
        <section class="card" id="checkins" style="margin-top:20px">
          <div class="mi-head">
            <h3><span class="material-symbols-outlined">history</span> Y√™u c·∫ßu Check-in/Check-out</h3>
          </div>
          <div id="ck-list" class="mi-list"></div>
        </section>
      </section>
    </main>
  </div>

  <script src="../common/script.js"></script>
  <script>
    ktxAuth.requireAuth(["admin"]);

    // ==== Hi·ªÉn th·ªã ng∆∞·ªùi d√πng ƒëang ƒëƒÉng nh·∫≠p
    (function(){
      const me = ktxAuth.getUser && ktxAuth.getUser();
      if (me){
        document.querySelector("[data-current-username]").textContent = me.username || "";
        document.querySelector("[data-current-role]").textContent = me.role || "";
      }
    })();

    // =================== CHECKINS LIST ===================
    async function updateCheckin(id, patch) {
      const res = await ktxAuth.apiFetch(`/checkins/${id}`, { method: "PATCH", body: JSON.stringify(patch) });
      if (!res.ok) throw new Error(`${res.status}`);
      return res.json();
    }

    async function approve(id) {
      try { await updateCheckin(id, { status: "approved" }); await loadCheckins(); alert("‚úÖ ƒê√£ duy·ªát y√™u c·∫ßu."); }
      catch (e) { alert("L·ªói: " + e.message); }
    }

    async function reject(id) {
      const note = prompt("Nh·∫≠p l√Ω do t·ª´ ch·ªëi (t√πy ch·ªçn):", "");
      try { await updateCheckin(id, { status: "rejected", admin_reply: note || null }); await loadCheckins(); alert("üö´ ƒê√£ t·ª´ ch·ªëi y√™u c·∫ßu."); }
      catch (e) { alert("L·ªói: " + e.message); }
    }

    async function reply(id) {
      const note = prompt("N·ªôi dung ph·∫£n h·ªìi:", "");
      if (note === null) return;
      try { await updateCheckin(id, { admin_reply: note }); await loadCheckins(); alert("üí¨ ƒê√£ ph·∫£n h·ªìi."); }
      catch (e) { alert("L·ªói: " + e.message); }
    }

    async function loadCheckins() {
      const box = document.getElementById('ck-list');
      box.innerHTML = '<p class="muted">ƒêang t·∫£i...</p>';
      try {
        const res = await ktxAuth.apiFetch('/checkins');
        const data = await res.json();
        if (!Array.isArray(data) || data.length === 0) {
          box.innerHTML = '<p class="muted">Ch∆∞a c√≥ y√™u c·∫ßu.</p>';
          return;
        }

        data.sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
        box.innerHTML = data.map(item => {
          const chipCls = item.status === 'approved' ? 'success' : item.status === 'rejected' ? 'danger' : 'info';
          const statusVN = item.status === 'approved' ? 'ƒê√£ duy·ªát' : item.status === 'rejected' ? 'T·ª´ ch·ªëi' : 'ƒêang ch·ªù';
          return `
            <article class="ticket">
              <div class="ticket-main">
                <div class="ticket-title">${item.type.toUpperCase()} ‚Ä¢ ${item.date}${item.time ? ' ' + item.time : ''}</div>
                <div class="ticket-meta">
                  <span class="meta"><span class="material-symbols-outlined">person</span> SV ID: ${item.student_id}</span>
                  <span class="meta"><span class="material-symbols-outlined">schedule</span> ${new Date(item.created_at).toLocaleString('vi-VN')}</span>
                  ${item.note ? `<span class="meta"><span class="material-symbols-outlined">notes</span> ${item.note}</span>` : ''}
                </div>
              </div>
              <div class="ticket-aside" style="display:flex;gap:8px;align-items:center">
                <span class="chip ${chipCls}">${statusVN}</span>
                <button class="btn ghost sm" onclick="reply(${item.id})"><span class="material-symbols-outlined">chat</span> Ph·∫£n h·ªìi</button>
                ${item.status !== 'approved' ? `<button class="btn primary sm" onclick="approve(${item.id})"><span class="material-symbols-outlined">check</span> Duy·ªát</button>` : ''}
                ${item.status !== 'rejected' ? `<button class="btn ghost sm" onclick="reject(${item.id})"><span class="material-symbols-outlined">close</span> T·ª´ ch·ªëi</button>` : ''}
              </div>
            </article>`;
        }).join('');
      } catch (e) {
        box.innerHTML = `<p class="muted">L·ªói t·∫£i d·ªØ li·ªáu: ${e.message}</p>`;
      }
    }

    // =================== CHART 1: Priority Summary ===================
    async function loadPrioritySummary() {
      const el = document.getElementById('priorityChart'); if (!el) return;
      let items = [];
      try { const res = await ktxAuth.apiFetch('/reports'); items = await res.json(); }
      catch (e) { console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c /reports:', e); }
      const counts = { normal: 0, high: 0, urgent: 0 };
      (Array.isArray(items) ? items : []).forEach(r => {
        const p = (r.priority || '').toLowerCase();
        if (p.includes('urgent') || p === 'kh·∫©n c·∫•p') counts.urgent++;
        else if (p.includes('high') || p === 'cao') counts.high++;
        else counts.normal++;
      });
      if (!counts.normal && !counts.high && !counts.urgent) { counts.normal = 2; counts.high = 1; counts.urgent = 1; }
      new Chart(el.getContext('2d'), {
        type: 'doughnut',
        data: { labels: ['B√¨nh th∆∞·ªùng','Cao','Kh·∫©n c·∫•p'], datasets:[{data:[counts.normal,counts.high,counts.urgent],backgroundColor:['#93c5fd','#f59e0b','#ef4444'],borderWidth:0}] },
        options: { responsive:true, cutout:'65%', plugins:{legend:{display:false}} }
      });
    }

    // =================== CHART 2: Checkin Summary ===================
    async function loadCheckinChart() {
      const el = document.getElementById('checkChart'); if (!el) return;
      let items = [];
      try { const res = await ktxAuth.apiFetch('/checkins'); items = await res.json(); }
      catch (e) { console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c /checkins:', e); }
      const c = { checkin: 0, checkout: 0 };
      (Array.isArray(items)?items:[]).forEach(r=>{
        const t=(r.type||'').toLowerCase();
        if(t.includes('out'))c.checkout++;else c.checkin++;
      });
      if(!c.checkin&&!c.checkout){c.checkin=2;c.checkout=1;}
      new Chart(el.getContext('2d'), {
        type: 'doughnut',
        data: { labels:['Check-in','Check-out'], datasets:[{data:[c.checkin,c.checkout],backgroundColor:['#22c55e','#3b82f6'],borderWidth:0}] },
        options: { responsive:true, cutout:'65%', plugins:{legend:{display:false}} }
      });
    }

    // =================== CHART 3: Category Summary (d·ªØ li·ªáu th·∫≠t t·ª´ /reports) ===================
    let _catChart = null;
    const _vn = (v)=> String(v ?? '').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
    const CATEGORY_MAP = {
      'dien': 'ƒêi·ªán',
      'nuoc': 'N∆∞·ªõc',
      've sinh': 'V·ªá sinh', 'vs': 'V·ªá sinh',
      'co so vat chat': 'C∆° s·ªü v·∫≠t ch·∫•t', 'csvc': 'C∆° s·ªü v·∫≠t ch·∫•t',
      'internet': 'Internet',
      'wifi': 'Internet',
      'khac': 'Kh√°c'
    };
    function pickCategory(r){
      // ∆Øu ti√™n category ng∆∞·ªùi d√πng; r·ªóng th√¨ d√πng nh√£n AI
      const raw = (r.category && r.category.trim()) ? r.category : (r.ai_label || '');
      const n = _vn(raw);
      if (!n) return 'Kh√°c';
      for (const k in CATEGORY_MAP){
        if (n === k || n.includes(k)) return CATEGORY_MAP[k];
      }
      return raw ? (raw[0].toUpperCase()+raw.slice(1)) : 'Kh√°c';
    }

    async function loadCategoryChart(){
      const el = document.getElementById('categoryChart');
      const empty = document.getElementById('catEmpty');
      if (!el) return;

      let reports = [];
      try {
        const res = await ktxAuth.apiFetch('/reports');
        if (!res.ok) throw new Error(await res.text());
        reports = await res.json();
      } catch (e) {
        console.warn('Kh√¥ng l·∫•y ƒë∆∞·ª£c /reports:', e);
        reports = [];
      }

      const counts = {};
      (Array.isArray(reports)?reports:[]).forEach(r=>{
        const k = pickCategory(r);
        counts[k] = (counts[k]||0)+1;
      });

      const labels = Object.keys(counts);
      const data = labels.map(l=>counts[l]);

      if (!labels.length){
        el.style.display = 'none';
        if (empty) empty.style.display = 'block';
        return;
      } else {
        el.style.display = '';
        if (empty) empty.style.display = 'none';
      }

      if (_catChart) { _catChart.destroy(); _catChart = null; }
      _catChart = new Chart(el.getContext('2d'), {
        type: 'bar',
        data: { labels, datasets: [{ data, borderWidth: 0 }] },
        options: {
          responsive: true,
          plugins: { legend: { display: false } },
          scales: { y: { beginAtZero: true, ticks: { precision:0 } } }
        }
      });
    }

    // L·∫Øng nghe thay ƒë·ªïi t·ª´ trang SV (ƒë√£ set localStorage 'ktx:reports:changed')
    window.addEventListener('storage', (ev)=>{
      if (ev.key === 'ktx:reports:changed') loadCategoryChart();
    });

    // =================== BOOT ===================
    document.addEventListener('DOMContentLoaded', ()=>{
      loadCheckins();
      loadPrioritySummary();
      loadCheckinChart();
      loadCategoryChart();       // <-- bi·ªÉu ƒë·ªì theo LO·∫†I
    });
  </script>
</body>
</html>
